/*							qlgam
 *
 *	Natural logarithm of gamma function
 *
 *
 *
 * SYNOPSIS:
 *
 * int qlgam( x, y );
 * QELT *x, *y;
 *
 * qlgam( x, y );
 *
 *
 *
 * DESCRIPTION:
 *
 * Returns the base e (2.718...) logarithm of the absolute
 * value of the gamma function of the argument.
 *
 *
 *	Gamma function
 *
 *
 *
 * SYNOPSIS:
 *
 * int qgamma( x, y );
 * QELT *x, *y;
 *
 * qgamma( x, y );
 *
 *
 *
 * DESCRIPTION:
 *
 * Returns gamma function of the argument.
 *
 * qgamma(x) = exp(qlgam(x))
 *
 * Cephes Math Library Release 2.2:  July, 1992
 * Copyright 1984, 1987, 1989, 1992 by Stephen L. Moshier
 */



#include "qhead.h"

/* constants for Stirling's formula */

//#define NG 71
#define USETABLE

#ifndef USETABLE
static char *gstrs[] = {
	"-1691737145614018979865561095112166189607682852147301400816480675916957871178648433284821493606361235973346584667336181793937950344828557898347149",
	"4470","148","147",
	"4120570026280114871526113315907864026165545608808541153973817680034790262683524284855810008621905238290240143481403022987037271683989824863",
	"6","146","145",
	"-3050244698373607565035155836901726357405007104256566761884191852434851033744761276392695669329626855965183503295793517411526056244431024612640493",
	"2381714790","144","143",
	"14731853280888589565870080442453214239804217023990642676194878997407546061581643106569966189211748270209483494554402556608073385149191",
	"6","142","141",
	"-3289490986435898803930699548851884006880537476931130981307467085162504802973618096693859598125274741604181467826651144393874696601946049",
	"679470","140","139",
	"2694866548990880936043851683724113040849078494664282483862150893060478501559546243423633375693325757795709438325907154973590288136429",
	"274386","138","137",
	"-84290226343367405131287578060366193649336612397547435767189206912230442242628212786558235455817749737691517685781164837036649737",
	"4110","136","135",
	"264590171870717725633635737248879015151254525593168688411918554840667765591690540727987316391252434348664694639349484190167",
	"6","134","133",
	"-410951945846993378209020486523571938123258077870477502433469747962650070754704863812646392801863686694106805747335370312946831",
	"4206930","132","131",
	"1928215175136130915645299522271596435307611010164728458783733020528548622403504078595174411693893882739334735142562418015",
	"8646","130","129",
	"-267754707742548082886954405585282394779291459592551740629978686063357792734863530145362663093519862048495908453718017",
	"510","128","127",
	"5556330281949274850616324408918951380525567307126747246796782304333594286400508981287241419934529638692081513802696639",
	"4357878","126","125",
	"-95876775334247128750774903107542444620578830013297336819553512729358593354435944413631943610268472689094609001",
	"30","124","123",
	"49633666079262581912532637475990757438722790311060139770309311793150683214100431329033113678098037968564431",
	"6","122","121",
	"-51507486535079109061843996857849983274095170353262675213092869167199297474922985358811329367077682677803282070131",
	"2328255930","120","119",
	"366963119969713111534947151585585006684606361080699204301059440676414485045806461889371776354517095799",
	"6","118","117",
	"-309553916571842976912513458033841416869004128064329844245504045721008957524571968271388199595754752259",
	"1770","116","115",
	"21737832319369163333310761086652991475721156679090831360806110114933605484234593650904188618562649",
	"42","114","113",
	"-2650879602155099713352597214685162014443151499192509896451788427680966756514875515366781203552600109",
	"1671270","112","111",
	"7645992940484742892248134246724347500528752413412307906683593870759797606269585779977930217515",
	"1518","110","109",
	"-3469342247847828789552088659323852541399766785760491146870005891371501266319724897592306597338057",
	"209191710","108","107",
	"36373903172617414408151820151593427169231298640581690038930816378281879873386202346572901",
	"642","106","105",
	"-319533631363830011287103352796174274671189606078272738327103470162849568365549721224053",
	"1590","104","103",
	"3204019410860907078243020782116241775491817197152717450679002501086861530836678158791",
	"4326","102","101",
	"-94598037819122125295227433069493721872702841533066936133385696204311395415197247711",
	"33330","100","99",
	"67908260672905495624051117546403605607342195728504487509073961249992947058239",
	"6","98","97",
	"-211600449597266513097597728109824233673043954389060234150638733420050668349987259",
	"4501770","96","95",
	"1220813806579744469607301679413201203958508415202696621436215105284649447",
	"6","94","93",
	"-1295585948207537527989427828538576749659341483719435143023316326829946247",
	"1410","92","91",
	"1179057279021082799884123351249215083775254949669647116231545215727922535",
	"272118","90","89",
	"-1311426488674017507995511424019311843345750275572028644296919890574047",
	"61410","88","87",
	"660714619417678653573847847426261496277830686653388931761996983","6",
	"86","85",
	"-2024576195935290360231131160111731009989917391198090877281083932477",
	"3404310","84","83",
	"1677014149185145836823154509786269900207736027570253414881613","498",
	"82","81",
	"-4603784299479457646935574969019046849794257872751288919656867","230010",
	"80","79",
	"414846365575400828295179035549542073492199375372400483487","3318","78","77",
	"-24655088825935372707687196040585199904365267828865801","30","76","75",
	"34152417289221168014330073731472635186688307783087","6","74","73",
	"-5827954961669944110438277244641067365282488301844260429","140100870",
	"72","71",
	"1505381347333367003803076567377857208511438160235","4686","70","69",
	"-78773130858718728141909149208474606244347001","30","68","67",
	"1472600022126335654051619428551932342241899101","64722","66","65",
	"-106783830147866529886385444979142647942017","510","64","63",
	"12300585434086858541953039857403386151","6","62","61",
	"-1215233140483755572040304994079820246041491","56786730","60","59",
	"84483613348880041862046775994036021","354","58","57",
	"-2479392929313226753685415739663229","870","56","55",
	"29149963634884862421418123812691","798","54","53",
	"-801165718135489957347924991853","1590","52","51",
	"495057205241079648212477525","66","50","49",
	"-5609403368997817686249127547","46410","48","47",
	"596451111593912163277961","282","46","45",
	"-27833269579301024235023","690","44","43",
	"1520097643918070802691","1806","42","41",
	"-261082718496449122051","13530","40","39",
	"2929993913841559","6","38","37",
	"-26315271553053477373","1919190","36","35",
	"2577687858367","6","34","33",
	"-7709321041217","510","32","31",
	"8615841276005","14322","30","29",
	"-23749461029","870","28","27",
	"8553103","6","26","25",
	"-236364091","2730","24","23",
	"854513","138","22","21",
	"-174611","330","20","19",
	"43867","798","18","17",
	"-3617","510","16","15",
	"7","6","14","13",
	"-691","2730","12","11",
	"5","66","10","9",
	"-1","30","8","7",
	"1","42","6","5",
	"-1","30","4","3",
	"1","6","2","1",
};
/* This is global so it can be used by qcgamma.c.  */
Qfloat EXPORT qgamcof[2*NG];
#else
#include "qgammacoef.c"
#endif
/* log(2*pi)/2 */
Qfloat EXPORT qgam12[1] = {
	0,EXPONE-1,0xeb3f8e4325f5a534ULL,0x94bc900144192023ULL,
	0xcfb08f8d13458b4dULL,0xdec6a3133daa155dULL,0x212f9d7fe00e86bfULL,
	0x93eabf905c5569bbULL,0xb05cab571b4cda5bULL };

#ifndef USETABLE
/* Initialize Stirling formula coefficients from ASCII strings.  */
int EXPORT qgamini = 0;

#include <stdio.h>
static void  hexbits(FILE *f,Qfloatp u)
{
        unsigned long long x[9];
        unsigned short e113[8];
        unsigned short d[8];
        int i, j;
        int *pi;
        long long *pll;

        qmovz( u,(QfloatAccump)x );
        /* Print Q-type value in hex.  */
        pi = (int *)x;
        fprintf(f,"{%d,0x%08x,",pi[0],pi[1]);
        j = 0;
        for( i=2; i<9; i++ )
        {
                fprintf(f, "0x%016llxULL,", x[i] );
                if( ++j > 3 ) {
                        j = 0;
                        fprintf( f, "\n" );
                }
        }
        fprintf( f,"},\n" );
}

void EXPORT initqgam(void)
{
	Qfloat den[1], temp[1];
	int i, k;

	FILE *f = fopen("qgammacoef.c","w");
	fprintf(f,"Qfloat qgamcof[]= {\n");
	qgamini = 1;
	k = 0;
	for( i=0; i<NG; i++ ) {
		fprintf(f,"/* %s,%s,%s,%s */\n",gstrs[k],gstrs[k+1],gstrs[k+2],gstrs[k+3]);
		asctoq( gstrs[k++], qgamcof+i,NULL);
		asctoq( gstrs[k++], den ,NULL);
		asctoq( gstrs[k++], temp ,NULL);
		qmul( den, temp, den );
		asctoq( gstrs[k++], temp,NULL );
		qmul( den, temp, den );
		qdiv( den, qgamcof+i, qgamcof+i);
		hexbits(f,qgamcof+i);
	}
	qgamini = 1;
	fprintf(f,"};\n");
	fclose(f);
}
#endif

/* natural logarithm of gamma function */

void EXPORT qlgam(Qfloatp x,Qfloatp y )
{
	Qfloat v[1], w[1], g[1], xx[1], t[1];
	Qfloatp p;
	long long lr;
	int i;

#ifndef USETABLE
	if( qgamini == 0 )
		initqgam();
#endif

	qmov( x, xx );
	if( signof(xx) != 0 ) {
		/* Test for negative integer.  */
		qfloor( xx, t );
		if( qcmp(xx, t) == 0 ) {
			qinfin(y);
			setpositive(y);
			return;
		}
		setpositive(xx);
		qlgam( xx, t );
		qmul( xx, qpi, g );	/* PI/(x * sin(PI*x))	*/
		qfsin( g, g );
		qmul( xx, g, g );
		qdiv( g, qpi, y );
		setpositive(y);
		qflog( y, y );
		qsub( t, y, y );	/* ... /gamma(x)	*/
		return;
	}
	/* range reduction: transform argument to be greater than 32 */
	qmov( qone, v );

	if( exponent(xx) > (QELT) (EXPONE + 5) )
		goto donrecur;

	qifrac( xx, &lr, t );

	while( lr < 92 ) // was 62
	{
		qmul( xx, v, v );
		qadd( qone, xx, xx );
		lr += 1;
	}

donrecur:

	qdiv( v, qone, v );

	/* Avoid overflow of xx * xx.  */
	if( (int) (exponent(xx) - EXPONE) >= (MAXEXP - EXPONE)/2 )
	{
		qclear(g);
		goto asymp;
	}
	/*  Asymptotic expansion in 1/x**2 for Stirling's formula */
	qmul( xx, xx, w );
	qdiv( w, qone, w );

	p = &qgamcof[0];
	qmul( w, p, g );
	p++;
	qadd( g, p, g );

	for( i=0; i<NG-2; i++ )
	{
		qmul( w, g, g );
		p ++;
		qadd( g, p, g );
	}

	qdiv( xx, g, g );

asymp:

	/* g + (x - 0.5)*log(x) - x + qgam12	*/
	qsub( qhalf, xx, t );
	qflog( xx, w );
	qmul( t, w, t );
	qsub( xx, t, t );
	qadd( qgam12, t, t );
	qadd( g, t, g );

	qflog( v, t );
	qadd( t, g, y );
}

/*							qgamma()	*/
/* gamma function check routine */


void EXPORT qgamma(Qfloatp xx,Qfloatp y )
{
	Qfloat t[1], s[1], x[1];

#ifndef USETABLE
	if( qgamini == 0 )
		initqgam();
#endif

	qmov( xx, x );
	if( signof(x) != 0 )
	{
		/* Test for negative integer.  */
		qfloor( xx, t );
		if( qcmp(xx, t) == 0 )
		{
			qinfin(y);
			setpositive(y);
			return ;
		}
		setpositive(x);
		qgamma( x, t );
		qmul( x, qpi, s );
		qfsin( s, s );
		qmul( x, s, s );
		qmul( s, t, t );
		qdiv( t, qpi, y );
		if(signof(y) == 0)
			setnegative(y);
		else
			setpositive(y);
		return;
	}
	qlgam( x, y );
	qfexp( y, y );
}

#if NOTUSED
/*  Asymptotic expansion in 1/x**2 for Stirling's formula */
int qlstir(QELT * xx,QELT * y )
{
	QELT w[NQ], g[NQ];
	QELT *p;
	int i;

#ifndef USETABLE
	if( qgamini == 0 )
		initqgam();
#endif

	qmul( xx, xx, w );
	qdiv( w, qone, w );

	p = &qgamcof[0][0];
	qmul( w, p, g );
	p += NQ;
	qadd( g, p, g );
	for( i=0; i<NG-2; i++ )
	{
		qmul( w, g, g );
		p += NQ;
		qadd( g, p, g );
	}
	qdiv( xx, g, y );
	return 0;
}
#endif
