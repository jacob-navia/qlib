/*							qpsi.c
 *	Psi (digamma) function check routine
 *
 *
 * SYNOPSIS:
 *
 * int qpsi( x, y );
 * QELT *x, *y;
 *
 * qpsi( x, y );
 *
 *
 * DESCRIPTION:
 *
 *              d      -
 *   psi(x)  =  -- ln | (x)
 *              dx
 *
 * is the logarithmic derivative of the gamma function.
 * For general positive x, the argument is made greater than 16
 * using the recurrence  psi(x+1) = psi(x) + 1/x.
 * Then the following asymptotic expansion is applied:
 *
 *                           inf.   B
 *                            -      2k
 * psi(x) = log(x) - 1/2x -   >   -------
 *                            -        2k
 *                           k=1   2k x
 *
 * where the B2k are Bernoulli numbers.
 *
 * psi(-x)  =  psi(x+1) + pi/tan(pi(x+1))
 *
 *
 * ACCURACY:
 *
 * Accuracy was about 36 decimals. 
   I improved this to 105 (jacob)
 *
 */

/*
Cephes Math Library Release 2.2:  July, 1992
Copyright 1984, 1987, 1992, 1995 by Stephen L. Moshier
 */

#include "qhead.h"

/* Expansion coefficients  */
/* It is not worth going further than B(59) since the precision of the package does
not allow any more precision. The maximum is then around 132 digits, verified with the
"Mathematica" package. jacob
 */
#define NP 59
char *pstrs[3*NP] = {
#if 0
	"-267754707742548082886954405585282394779291459592551740629978686063357792734863530145362663093519862048495908453718017","510","128",
	"5556330281949274850616324408918951380525567307126747246796782304333594286400508981287241419934529638692081513802696639","4357878","126",
	"-95876775334247128750774903107542444620578830013297336819553512729358593354435944413631943610268472689094609001","30","124",
	"49633666079262581912532637475990757438722790311060139770309311793150683214100431329033113678098037968564431","6","122",
	"-51507486535079109061843996857849983274095170353262675213092869167199297474922985358811329367077682677803282070131","2328255930","120",
#endif
	"366963119969713111534947151585585006684606361080699204301059440676414485045806461889371776354517095799","6","118",
	"-309553916571842976912513458033841416869004128064329844245504045721008957524571968271388199595754752259","1770","116",
	"21737832319369163333310761086652991475721156679090831360806110114933605484234593650904188618562649","42","114",
	"-2650879602155099713352597214685162014443151499192509896451788427680966756514875515366781203552600109","1671270","112",
	"7645992940484742892248134246724347500528752413412307906683593870759797606269585779977930217515","1518","110",
	"-3469342247847828789552088659323852541399766785760491146870005891371501266319724897592306597338057","209191710","108",
	"36373903172617414408151820151593427169231298640581690038930816378281879873386202346572901","642","106",
	"-319533631363830011287103352796174274671189606078272738327103470162849568365549721224053","1590","104",
	"3204019410860907078243020782116241775491817197152717450679002501086861530836678158791","4326","102",
	"-94598037819122125295227433069493721872702841533066936133385696204311395415197247711","33330","100",
	"67908260672905495624051117546403605607342195728504487509073961249992947058239","6","98",
	"-211600449597266513097597728109824233673043954389060234150638733420050668349987259","4501770","96",
	"1220813806579744469607301679413201203958508415202696621436215105284649447","6","94",
	"-1295585948207537527989427828538576749659341483719435143023316326829946247","1410","92",
	"1179057279021082799884123351249215083775254949669647116231545215727922535","272118","90",
	"-1311426488674017507995511424019311843345750275572028644296919890574047","61410","88",
	"660714619417678653573847847426261496277830686653388931761996983","6","86",
	"-2024576195935290360231131160111731009989917391198090877281083932477","3404310","84",
	"1677014149185145836823154509786269900207736027570253414881613","498","82",
	"-4603784299479457646935574969019046849794257872751288919656867","230010","80",
	"414846365575400828295179035549542073492199375372400483487","3318","78",
	"-24655088825935372707687196040585199904365267828865801","30","76",
	"34152417289221168014330073731472635186688307783087","6","74",
	"-5827954961669944110438277244641067365282488301844260429","140100870","72",
	"1505381347333367003803076567377857208511438160235","4686","70",
	"-78773130858718728141909149208474606244347001","30","68",
	"1472600022126335654051619428551932342241899101","64722","66",
	"-106783830147866529886385444979142647942017","510","64",
	"12300585434086858541953039857403386151","6","62",
	"-1215233140483755572040304994079820246041491","56786730","60",
	"84483613348880041862046775994036021","354","58",
	"-2479392929313226753685415739663229","870","56",
	"29149963634884862421418123812691","798","54",
	"-801165718135489957347924991853","1590","52",
	"495057205241079648212477525","66","50",
	"-5609403368997817686249127547","46410","48",
	"596451111593912163277961","282","46",
	"-27833269579301024235023","690","44",
	"1520097643918070802691","1806","42",
	"-261082718496449122051","13530","40",
	"2929993913841559","6","38",
	"-26315271553053477373","1919190","36",
	"2577687858367","6","34",
	"-7709321041217","510","32",
	"8615841276005","14322","30",
	"-23749461029","870","28",
	"8553103","6","26",
	"-236364091","2730","24",
	"854513","138","22",
	"-174611","330","20",
	"43867","798","18",
	"-3617","510","16",
	"7","6","14",
	"-691","2730","12",
	"5","66","10",
	"-1","30","8",
	"1","42","6",
	"-1","30","4",
	"1","6","2",
};

static Qfloat pcof[NP];

/* Initialize coefficients from ASCII strings.  */
static int qpsiini = 0;

static int initqpsi(void)
{
	Qfloat den[1], temp[1];
	int i, k;

	k = 0;
	for( i=0; i<NP; i++ )
	{
		/* One numerator coefficient */
		asctoq( pstrs[k++], pcof+i ,NULL);
		/* Two denominator factors */
		asctoq( pstrs[k++], temp ,NULL);
		asctoq( pstrs[k++], den ,NULL);
		qmul( den, temp, den );
		qdiv( den, pcof+i, pcof+i );
	}
	qpsiini = 1;
	return 0;
}

void EXPORT Bernoulliq(Qfloatp result,int x)
{
	int m,n;
	Qfloat c480[1], nSquared[1], t1[1], t2[1], qm[1], t3[1], t5[1];

	if (qpsiini == 0)
		initqpsi();
	if (x&1) {
		qclear(result);
		return;
	}
	m = x/2;
	if (m <=50) {
		qmov(pcof+51-m,result);
		itoq(x,t1);
		qmul(result,t1,result);
		return;
	}
	asctoq("480",c480,NULL);
	n = m*m;
	itoq(n,nSquared);
	qmul(nSquared,c480,t1); // t1 = 480n^2
	qadd(t1,qnine,t2);      // t2 = 480n^2 + 9
	qsub(qone,t1,t3);       // t3 = 480n^2 - 1
	itoq(m,qm);
	qmul(qpi,qexp1,t5);
	qdiv(t5,qm,t5);         // t4 = (480n^2+9)*n/2
	qdiv(t3,t2,t2);
	qmul(t2,t5,t2);
	qmul(qm,qtwo,t5);
	qfpow(t2,t5,t2);
	qmul(qpi,qm,t1);
	qfsqrt(t1,t1);
	qmul(qtwo,qtwo,t3);
	qmul(t3,t1,t1);
	qmul(t1,t2,result);
	if (0 == (m&1))
		result[0].sign = -1;
}



void EXPORT qpsi(Qfloatp x,Qfloatp y)
{
	Qfloat v[1], w[1], g[1], xx[1], t[1];
	int i;

	if (qpsiini == 0)
		initqpsi();

	if( x[0].sign != 0 )
	{
		/* psi(-x)  =  psi(x+1) + pi/tan(pi(x+1)) */
		qmov( x, xx );
		xx[0].sign = 0;
		qadd( qone, xx, xx );
		qpsi( xx, t );
		qmul( xx, qpi, g );
		qftan( g, g );
		qdiv( g, qpi, w );
		qadd( t, w, y );
		return;
	}
	/* range reduction: transform argument to be greater than 64 */
	qmov( x, xx );
	qclear(v);

	while( xx[0].exponent <= (QELT) (EXPONE + 6) )	/* exponent of 64 */
	{
		qdiv( xx, qone, w );
		qadd( w, v, v );
		qadd( qone, xx, xx );
	}

	/*  Asymptotic polynomial in 1/x**2 for Stirling's formula	*/
	qmul( xx, xx, w );
	qdiv( w, pcof, g );
	for( i = 1; i < NP; i++ )
	{
		qadd( g, pcof+i, g );
		qdiv( w, g, g );
	}
	/* g + 1/2x - log(x) */
	qdiv( xx, qone, w );
	w[0].exponent -= 1;
	qadd( w, g, g );
	qflog( xx, w );
	qsub( w, g, g );
	/* negate */
	qneg(g);
	/* We now have psi(xx). Subtract sum of reciprocals. */
	qsub( v, g, y );
}
